name: Python Multi-Job CI

on: [push, pull_request]

jobs:
  build:
    name: Build and Install
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        echo "=== ÉTAPE BUILD ==="
        pip install -r requirements.txt
        echo "✅ Dépendances installées avec succès"
        
    - name: Verify installation
      run: |
        python -c "import app; print('✅ Application importée avec succès')"
        python -c "import pytest; print('✅ Pytest disponible')"

  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: pip install -r requirements.txt
      
    - name: Run tests with coverage
      run: |
        echo "=== ÉTAPE TESTS ==="
        pytest --cov=app --cov-report=term-missing --maxfail=1 --disable-warnings -v
        echo "✅ Tests exécutés avec succès"

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install linters
      run: pip install flake8 black
      
    - name: Auto-format with Black
      run: |
        echo "=== FORMATAGE AUTOMATIQUE ==="
        black app/ tests/
        echo "✅ Code formaté avec Black"
      
    - name: Run Flake8 (permissif)
      run: |
        echo "=== ÉTAPE QUALITÉ ==="
        flake8 app/ tests/ --max-line-length=100 --extend-ignore=E302,W293,E501 || echo "⚠️  Quelques erreurs de style détectées"
        echo "✅ Vérification qualité terminée"
        
    - name: Check Black formatting
      run: |
        black --check app/ tests/
        echo "✅ Format Black validé"

  success:
    name: Pipeline Success
    runs-on: ubuntu-latest
    needs: [build, tests, quality]
    if: always()
    
    steps:
    - name: Pipeline status
      run: |
        echo "=== RÉSUMÉ PIPELINE ==="
        echo "📦 Build: ${{ needs.build.result }}"
        echo "🧪 Tests: ${{ needs.tests.result }}"
        echo "🛠️  Qualité: ${{ needs.quality.result }}"
        echo ""
        if [[ '${{ needs.build.result }}' == 'success' && '${{ needs.tests.result }}' == 'success' ]]; then
          echo "🎉 PIPELINE RÉUSSIE ! (Qualité: ${{ needs.quality.result }})"
        else
          echo "❌ Pipeline échouée"
          exit 1
        fi
